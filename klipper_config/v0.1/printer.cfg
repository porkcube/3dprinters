# This file contains common pin mappings for the BIGTREETECH SKR
# MINI 2.0. To use this config, the firmware should be compiled for 
# the STM32F103 with a "28KiB bootloader". Also select "enable extra 
# low-level configuration options" and configure "GPIO pins to set 
# at micro-controller startup" to "!PA14".

# The "make flash" command does not work on the SKR mini. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini with that SD card.

## Voron Design VORON 0.1 SKR Mini E3 V2 config

## *** THINGS TO CHANGE/CHECK: ***
## MCU path                                                                     [mcu] section
## Z and Extruder motor currents                                                [tmc2209 stepper_*] sections. Uncomment the stepper motor you have
## Full steps per rotation for Extruder                                         [extruder] section
## Thermistor types                                                             [extruder] and [heater_bed] sections - See 'sensor types' list at end of file
## Extruder motor currents                                                      [extruder] section
## PID tune                                                                     [extruder] and [heater_bed] sections
## Fine tune E steps                                                            [extruder] section
## For more info                                                                check https://docs.vorondesign.com/build/startup/#v0

[mcu]
#####################################################################
# Obtain definition by "ls -l /dev/serial/by-id/"
#####################################################################
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_32FFD9055646363333712443-if00

[printer]
kinematics: corexy
#max_velocity: 350
#max_accel: 3000
#max_z_velocity: 50
#max_z_accel: 350
#square_corner_velocity: 10.0                                                      
##
# tuned
max_velocity: 500
max_accel: 10000
# original
#max_velocity: 300
#max_accel: 3000
max_z_velocity: 25
max_z_accel: 50
##
#max_velocity: 200
#max_accel: 1500
#max_z_velocity: 15
#max_z_accel: 45
square_corner_velocity: 5.0

#####################################################################
#      X/Y Stepper Settings
#####################################################################
# motor B
[stepper_x]
step_pin: PB10
## Refer to https://docs.vorondesign.com/build/startup/#v0
dir_pin: PB2                                                        # Check motor direction in link above. If inverted, add a ! before PB2
enable_pin: !PB11
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200                                        # Set to 400 for 0.9° degree stepper motor, 200 is for 1.8° stepper motors
endstop_pin: ^PC0
position_endstop: 120  # 114 / 120
position_max: 120      # 114 / 120
##position_min: 0
homing_speed: 50                                                    # Can be increased after initial setup, Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
interpolate: False
run_current: 0.5
##hold_current: 0.25
sense_resistor: 0.110
stealthchop_threshold: 0                                            # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle

# motor A
[stepper_y]
step_pin: PB13
## Refer to https://docs.vorondesign.com/build/startup/#v0
dir_pin: PB12                                                       # Check motor direction in link above. If inverted, add a ! before PB12
enable_pin: !PB14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200                                        # Set to 400 for 0.9° degree stepper motor, 200 is for 1.8° stepper motors
endstop_pin: ^PC1
position_endstop: 120   # 119 / 120
position_max: 120       # 119 / 120
##position_min: 0
homing_speed: 50                                                    # Can be increased after initial setup, Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
interpolate: False
run_current: 0.5
##hold_current: 0.25
sense_resistor: 0.110
stealthchop_threshold: 0                                            # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle

#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PB0
dir_pin: !PC5                                                       # Remove the ! before PC5 if motor direction is inverted.
enable_pin: !PB1
rotation_distance: 8                                                # For T8x8 integrated lead screw
microsteps: 32
endstop_pin: ^PC2
position_endstop = 0.040        # -0.260 / -0.180 / -0.220 /-0.320 / -0.420 / -0.470 / -0.510 / 0.470 # -0.120 smooth / -0.130 textured
position_max: 115               # 120 / 115
position_min: -1.5              # -1.5 / 5
homing_speed: 10
second_homing_speed: 3.0
homing_retract_dist: 3.0

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
interpolate: False
## For LDO-42STH25-1004CL200E 1.0A
run_current: 0.37
##hold_current: 0.35
sense_resistor: 0.110
stealthchop_threshold: 0                                            # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle

#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: PB3
dir_pin: !PB4                                                        # Add ! if moving opposite direction
enable_pin: !PD2
full_steps_per_rotation: 200                                        # Set to 200 for LDO 1.8° stepper motor, and set to 400 for OMC(StepperOnline) 0.9° stepper motor
rotation_distance: 21.95                                            # See calibrating rotation_distance on extruders doc
gear_ratio: 50:10                                                   # For Mini Afterburner
microsteps: 32
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC8
sensor_type: Trianglelab NTC100K B3950                              # Adjust for your hotend thermistor. See 'sensor types' list at end of file
sensor_pin: PA0
control = pid
pid_kp = 22.582
pid_ki = 1.276
pid_kd = 99.927
min_temp: -100
max_temp: 270
min_extrude_temp: 165
max_extrude_only_distance: 150
max_extrude_cross_section: 0.8
pressure_advance: 0.039           # 0.030 default 0.0 / PLA 0.045 / ABS 0.039                                   # See tuning pressure advance doc
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
interpolate: False
## For OMC (StepperOnline) 14HR07-1004VRN 1A 0.9°
#run_current: 0.5	# for OMC 14HR07-1004VRN rated at 1A
#hold_current: 0.3	# for OMC 14HR07-1004VRN rated at 1A
## For LDO LDO 36STH17-1004AHG 1A 1.8° 
run_current: 0.3	# for LDO 36STH17-1004AHG
hold_current: 0.2	# for LDO 36STH17-1004AHG
sense_resistor: 0.110
stealthchop_threshold: 0                                            # Set to 0 for spreadcycle, avoid using stealthchop on extruder

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PC9
sensor_type: NTC 100K MGB18-104F39050L32                            # For Keenovo, verify yours
sensor_pin: PC3
smooth_time: 3.0
#max_power: 0.6                                                     # Only needed for 100w pads
min_temp: 0
max_temp: 120
control = pid
pid_kp = 63.742
pid_ki = 2.114
pid_kd = 480.458
pwm_cycle_time: 0.0166                                               # 60Hz

#####################################################################
#	Thermistor / Temp Sensors definitions
#####################################################################

[thermistor Trianglelab NTC100K B3950]
## values calibrated against a PT100 reference
temperature1: 25.0
resistance1: 103180.0
temperature2: 150.0
resistance2: 1366.2
temperature3: 250.0
resistance3: 168.6

[temperature_sensor SKR_mini_E3_v2]
sensor_type: temperature_mcu
gcode_id: SKR-mini-E3-v2

#####################################################################
#	Fan Control
#####################################################################

[heater_fan hotend_fan]
pin: PC7 # PC7 / PC13
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
#fan_speed: 1.0	                                                    # You can't PWM the delta fan unless using blue wire
shutdown_speed: 0.0

[fan]
pin: PC6
max_power: 1.0
kick_start_time: 0.5                                                # Depending on your fan, you may need to increase this value if your fan will not start
off_below: 0.13
cycle_time: 0.010

#[output_pin caselight]
#pin: PC7
#pwm:true
#shutdown_value: 0
#value:0.25
#cycle_time: 0.01

#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

## Disabled for Klicky
#[safe_z_home]
#home_xy_position: 120,120               # 114 / 119
#speed: 50.0
#z_hop: 5

## To be used with BED_SCREWS_ADJUST
[bed_screws]
screw1: 60,5
screw1_name: front screw
screw2: 10,100                          # 5,115
screw2_name: back left
screw3: 110,110                         # 115, 115
screw3_name: back right

#####################################################################
#	Input Shaper
#####################################################################
[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 76.3
shaper_type_y = mzv
shaper_freq_y = 73.6


#####################################################################
#	Macros
#####################################################################

#[gcode_macro PRINT_START]
##   Use PRINT_START for the slicer starting script - please customize for your slicer of choice
#gcode:
#    M117 Homing
#    G28                            ; home all axes
#    LED_RED
#    G1 Z20 F3000                   ; move nozzle away from bed
#    G1 X2 Y20 Z2 F3000
#    G1 Z0.28 F240
#    G92 E0
#    G1 Y115 E10 F1500
#    G1 X2.3 F3000
#    G1 Y20 E15 F1500
#    LED_GREEN
#    M117 Printing

[gcode_macro PRINT_START]
description: PRINT_START macro, needs BED_TEMP and EXTRUDER_TEMP passed from slicer
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    # set and wait for bed to heat
    M190 S{BED_TEMP}
    # start warming up extruder to modest temp, no wait
    M104 S160
    # home + fresh mesh
    LED_RED
    G28
    BED_MESH_CALIBRATE
    # use absolute coordinates
    G90
    # move the nozzle near the bed
    G1 Z20 F3000
    # move the nozzle very close to the bed
    G1 Z0.15 F300
    # set and wait for nozzle to reach printing temp
    M104 S{EXTRUDER_TEMP}
    # purge/prime
    G1 Z20 F3000
    G1 X2 Y20 Z2 F3000
    M109 S{EXTRUDER_TEMP}
    G1 Z0.28 F240
    G92 E0
    G1 Y115 E10 F1500
    G1 X2.3 F3000
    G1 Y20 E15 F1500
    LED_GREEN

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
gcode:
    M117 Print Ending
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-4.0 F3600                 ; retract filament
    G91                            ; relative positioning

    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    #   Check end position to determine safe direction to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    LED_ORANGE
    G0 Z{z_safe} F3600             ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    G0 X60 Y{max_y} F3600          ; park nozzle at rear
    M117 Print Complete

[gcode_macro FIL_LOAD]
gcode:
   M117 Load Filament
   M83                            ; set extruder to relative
   G1 E30 F300                    ; load
   G1 E15 F150                    ; prime nozzle with filament
   M82                            ; set extruder to absolute
    
[gcode_macro FIL_UNL]
gcode:
   M117 Unload Filament
   M83                            ; set extruder to relative
   G1 E10 F300                    ; extrude a little to soften tip
   G1 E-40 F1800                  ; retract some, but not too much or it will jam
   M82                            ; set extruder to absolute

## my macros
[gcode_macro BED_LEVEL]
gcode:
    G28                            ; home all axis
    BED_SCREWS_ADJUST              ; screw adjustment

[gcode_macro LED_BLUE]
gcode:
    SET_LED LED=displayStatus RED=0 GREEN=0 BLUE=0.2 SYNC=0

[gcode_macro LED_GREEN]
gcode:
    SET_LED LED=displayStatus RED=0 GREEN=0.2 BLUE=0 SYNC=0

[gcode_macro LED_ORANGE]
gcode:
    SET_LED LED=displayStatus RED=0.2 GREEN=0.1 BLUE=0 SYNC=0

[gcode_macro LED_RED]
gcode:
    SET_LED LED=displayStatus RED=0.2 GREEN=0 BLUE=0 SYNC=0

[gcode_macro XY_60]
gcode:
    G91
    G1 X60 Y60

[gcode_macro Z_75]
gcode:
    G91
    G1 Z75

[gcode_macro TEST_SPEED]
gcode:
	# Speed
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	# Iterations
	{% set iterations = params.ITERATIONS|default(5)|int %}
	# Acceleration
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	# Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
	{% set bound = params.BOUND|default(20)|int %}
	# Size for small pattern box
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	# Large pattern
		# Max positions, inset by BOUND
		{% set x_min = printer.toolhead.axis_minimum.x + bound %}
		{% set x_max = printer.toolhead.axis_maximum.x - bound %}
		{% set y_min = printer.toolhead.axis_minimum.y + bound %}
		{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	# Small pattern at center
		# Find X/Y center point
		{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
		{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
		
		# Set small pattern box around center point
		{% set x_center_min = x_center - (smallpatternsize/2) %}
		{% set x_center_max = x_center + (smallpatternsize/2) %}
		{% set y_center_min = y_center - (smallpatternsize/2) %}
		{% set y_center_max = y_center + (smallpatternsize/2) %}

	# Save current gcode state (absolute/relative, etc)
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	# Output parameters to g-code terminal
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	# Home and get position for comparison later:
		G28
		# QGL if not already QGLd (only if QGL section exists in config)
		{% if printer.configfile.settings.quad_gantry_level %}
			{% if printer.quad_gantry_level.applied == False %}
				QUAD_GANTRY_LEVEL
				G28 Z
			{% endif %}
		{% endif %}	
		G90
		G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
		G4 P1000 
		GET_POSITION

	# Go to starting position
	G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

	# Set new limits
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}

	{% for i in range(iterations) %}
		# Large pattern
			# Diagonals
			G0 X{x_min} Y{y_min} F{speed*60}
			G0 X{x_max} Y{y_max} F{speed*60}
			G0 X{x_min} Y{y_min} F{speed*60}
			G0 X{x_max} Y{y_min} F{speed*60}
			G0 X{x_min} Y{y_max} F{speed*60}
			G0 X{x_max} Y{y_min} F{speed*60}
			
			# Box
			G0 X{x_min} Y{y_min} F{speed*60}
			G0 X{x_min} Y{y_max} F{speed*60}
			G0 X{x_max} Y{y_max} F{speed*60}
			G0 X{x_max} Y{y_min} F{speed*60}
		
		# Small pattern
			# Small diagonals 
			G0 X{x_center_min} Y{y_center_min} F{speed*60}
			G0 X{x_center_max} Y{y_center_max} F{speed*60}
			G0 X{x_center_min} Y{y_center_min} F{speed*60}
			G0 X{x_center_max} Y{y_center_min} F{speed*60}
			G0 X{x_center_min} Y{y_center_max} F{speed*60}
			G0 X{x_center_max} Y{y_center_min} F{speed*60}
			
			# Small box
			G0 X{x_center_min} Y{y_center_min} F{speed*60}
			G0 X{x_center_min} Y{y_center_max} F{speed*60}
			G0 X{x_center_max} Y{y_center_max} F{speed*60}
			G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}

	# Restore max speed/accel/accel_to_decel to their configured values
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel} 

	# Re-home and get position again for comparison:
		G28
		# Go to XY home positions (in case your homing override leaves it elsewhere)
		G90
		G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
		G4 P1000 
		GET_POSITION

	# Restore previous gcode state (absolute/relative, etc)
	RESTORE_GCODE_STATE NAME=TEST_SPEED



##   Sensor Types
##   "Trianglelab NTC100K B3950" (Beta 3950 used in LDO kits)
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "Generic 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"
##   "PT1000"
##   For more information: https://www.klipper3d.org/Config_Reference.html#temperature_sensor

## Footnote about Beta 3950:
## https://github.com/Klipper3d/klipper/issues/4054
## https://github.com/Klipper3d/klipper/pull/4859

[include mainsail.cfg]
# v0 display
[include display.cfg]
# raspi as klipper mcu
[include raspi-mcu.cfg]
# klicky + auto-z
[include ./klicky/klicky-probe.cfg]
# timelapse
[include ../moonraker-timelapse/klipper_macro/timelapse.cfg]
# umbilical mod support
[include umbilical.cfg]
# accelerometer for input shaping
#[include adxl-pico.cfg]
#[include adxl-qt.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh initial]
#*# version = 1
#*# points =
#*# 	-0.110000, -0.063750, -0.071250, -0.145000, -0.178750
#*# 	-0.046250, -0.010000, -0.001250, -0.015000, -0.061250
#*# 	-0.002500, 0.005000, 0.000000, -0.001250, -0.018750
#*# 	-0.041250, -0.007500, 0.002500, -0.003750, -0.013750
#*# 	-0.072500, -0.006250, 0.013750, 0.013750, -0.005000
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 15.0
#*# x_count = 5
#*# max_y = 105.0
#*# mesh_x_pps = 2
#*# max_x = 105.0
#*#
#*# [bed_mesh heatsoak]
#*# version = 1
#*# points =
#*# 	-0.082500, -0.046250, -0.050000, -0.116250, -0.142500
#*# 	-0.053750, 0.002500, 0.021250, -0.016250, -0.055000
#*# 	-0.011250, 0.006250, 0.000000, -0.007500, -0.038750
#*# 	-0.078750, -0.050000, -0.018750, -0.025000, -0.048750
#*# 	-0.122500, -0.066250, -0.022500, -0.020000, -0.058750
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 15.0
#*# x_count = 5
#*# max_y = 105.0
#*# mesh_x_pps = 2
#*# max_x = 105.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.085000, -0.065000, -0.121250, -0.178750
#*# 	-0.012500, 0.027500, 0.011250, -0.018750
#*# 	0.000000, 0.032500, 0.035000, 0.023750
#*# 	0.042500, 0.101250, 0.102500, 0.097500
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = lagrange
#*# y_count = 4
#*# mesh_y_pps = 2
#*# min_y = 15.0
#*# x_count = 4
#*# max_y = 105.0
#*# mesh_x_pps = 2
#*# max_x = 105.0
